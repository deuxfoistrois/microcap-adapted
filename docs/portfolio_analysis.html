<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Performance Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin: 0;
            font-weight: 700;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .position-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .position-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }
        
        .position-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .symbol {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .price {
            font-size: 1.1rem;
            color: #27ae60;
            font-weight: 600;
        }
        
        .position-details {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .footer {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 20px;
        }
        
        canvas {
            max-height: 400px !important;
        }
        
        .data-source {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #0c5460;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Portfolio Performance Analysis</h1>
            <p>Professional Micro-Cap Strategy Tracking</p>
        </div>
        
        <div id="loading" class="loading">
            Loading portfolio data...
        </div>
        
        <div id="error" class="error" style="display: none;">
            Failed to load portfolio data. Using fallback data for demonstration.
        </div>
        
        <div id="content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="current-value">$1,203.60</div>
                    <div class="stat-label">Current Value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-return">+20.9%</div>
                    <div class="stat-label">Total Return</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="daily-change">+$30.55</div>
                    <div class="stat-label">Daily Change</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="days-elapsed">19</div>
                    <div class="stat-label">Days Elapsed</div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Portfolio Value Timeline</div>
                    <canvas id="portfolioChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Current Allocation</div>
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">Individual Position Values</div>
                <canvas id="positionsChart"></canvas>
            </div>
            
            <div class="position-grid" id="positions-grid">
                <!-- Position cards will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="data-source">
            <strong>Data Source:</strong> <span id="data-source-info">Loading...</span><br>
            <strong>Last Updated:</strong> <span id="last-updated">--</span><br>
            <strong>Next Refresh:</strong> <span id="next-refresh">--</span>
        </div>
        
        <div class="footer">
            <p>Professional trading analysis dashboard | Real-time portfolio tracking</p>
        </div>
    </div>

    <script>
        console.log('Portfolio Analysis Dashboard Initializing...');
        
        let portfolioChart, allocationChart, positionsChart;
        let refreshTimer;
        
        // Complete timeline with all trading days (Mon-Fri only)
        const generateTradingDays = (startDate, endDate) => {
            const days = [];
            const current = new Date(startDate);
            const end = new Date(endDate);
            
            while (current <= end) {
                const dayOfWeek = current.getDay();
                // Only include Mon-Fri (1-5)
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    days.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            return days;
        };
        
        // Generate complete trading timeline from Aug 8 to Aug 29
        const tradingDays = generateTradingDays('2025-08-08', '2025-08-29');
        const dateLabels = tradingDays.map(date => 
            date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        );
        
        console.log('Generated trading days:', dateLabels);
        
        // Key portfolio milestones with interpolation
        const keyMilestones = {
            '2025-08-08': { total: 995.74, ARQ: 250, GEVO: 250, FEIM: 250, UPXI: 200, cash: 45.74 },
            '2025-08-12': { total: 1180.50, ARQ: 262, GEVO: 420, FEIM: 285, UPXI: 133, cash: 80.50 },
            '2025-08-13': { total: 1326.74, ARQ: 268, GEVO: 595, FEIM: 316, UPXI: 127, cash: 20.74 }, // Peak
            '2025-08-15': { total: 1258.42, ARQ: 265, GEVO: 486, FEIM: 298, UPXI: 129, cash: 80.42 },
            '2025-08-18': { total: 1181.35, ARQ: 262, GEVO: 334, FEIM: 284, UPXI: 121, cash: 180.35 },
            '2025-08-19': { total: 1139.64, ARQ: 262, GEVO: 0, FEIM: 0, UPXI: 107, SERV: 250, MYOMO: 240, CABA: 181, cash: 99.64 },
            '2025-08-20': { total: 1134.92, ARQ: 263.44, GEVO: 0, FEIM: 0, UPXI: 118.66, SERV: 240.50, MYOMO: 234.08, CABA: 179.20, cash: 99.04 },
            '2025-08-21': { total: 1134.92, ARQ: 263.44, GEVO: 0, FEIM: 0, UPXI: 118.66, SERV: 240.50, MYOMO: 234.08, CABA: 179.20, cash: 99.04 },
            '2025-08-22': { total: 1178.86, ARQ: 263.44, GEVO: 0, FEIM: 0, UPXI: 134.81, SERV: 252.46, MYOMO: 247.67, CABA: 181.44, cash: 99.04 },
            '2025-08-23': { total: 1187.80, ARQ: 273, GEVO: 0, FEIM: 0, UPXI: 63, SERV: 304, MYOMO: 413, CABA: 181, cash: 4 },
            '2025-08-26': { total: 1173.05, ARQ: 271.95, GEVO: 0, FEIM: 0, UPXI: 68.44, SERV: 267.02, MYOMO: 390.25, CABA: 171.36, cash: 4.03 },
            '2025-08-27': { total: 1203.60, ARQ: 271.95, GEVO: 0, FEIM: 0, UPXI: 65.76, SERV: 301.86, MYOMO: 392.00, CABA: 168.00, cash: 4.03 }
        };
        
        // Interpolate values for all trading days
        const interpolateValue = (day1, day2, value1, value2, currentDay) => {
            const totalDays = (new Date(day2) - new Date(day1)) / (1000 * 60 * 60 * 24);
            const daysPassed = (new Date(currentDay) - new Date(day1)) / (1000 * 60 * 60 * 24);
            const ratio = daysPassed / totalDays;
            return value1 + (value2 - value1) * ratio;
        };
        
        const generateCompleteData = () => {
            const completeData = [];
            const milestoneKeys = Object.keys(keyMilestones).sort();
            
            tradingDays.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                
                if (keyMilestones[dateStr]) {
                    // Use exact milestone data
                    completeData.push({
                        date: dateStr,
                        ...keyMilestones[dateStr]
                    });
                } else {
                    // Interpolate between milestones
                    let beforeMilestone = null;
                    let afterMilestone = null;
                    
                    for (let i = 0; i < milestoneKeys.length - 1; i++) {
                        if (dateStr > milestoneKeys[i] && dateStr < milestoneKeys[i + 1]) {
                            beforeMilestone = milestoneKeys[i];
                            afterMilestone = milestoneKeys[i + 1];
                            break;
                        }
                    }
                    
                    if (beforeMilestone && afterMilestone) {
                        const before = keyMilestones[beforeMilestone];
                        const after = keyMilestones[afterMilestone];
                        
                        const interpolatedData = { date: dateStr };
                        Object.keys(before).forEach(key => {
                            if (key !== 'date') {
                                interpolatedData[key] = interpolateValue(
                                    beforeMilestone, afterMilestone, 
                                    before[key], after[key], dateStr
                                );
                            }
                        });
                        completeData.push(interpolatedData);
                    }
                }
            });
            
            return completeData;
        };
        
        const completeTimelineData = generateCompleteData();
        console.log('Complete timeline data:', completeTimelineData);
        
        async function loadPortfolioData() {
            const dataSources = [
                'docs/latest.json',
                './docs/latest.json',
                '/docs/latest.json',
                'latest.json',
                './latest.json',
                'https://raw.githubusercontent.com/deuxfoistrois/microcap-adapted/main/docs/latest.json'
            ];
            
            for (const source of dataSources) {
                try {
                    console.log(`Trying to fetch from: ${source}`);
                    const response = await fetch(source + '?t=' + Date.now());
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Successfully loaded data:', data);
                        document.getElementById('data-source-info').textContent = source;
                        return data;
                    } else {
                        console.log(`Failed to fetch from ${source}: ${response.status}`);
                    }
                } catch (error) {
                    console.log(`Error fetching from ${source}:`, error);
                }
            }
            
            // Fallback to latest known data
            console.log('Using fallback data');
            document.getElementById('error').style.display = 'block';
            document.getElementById('data-source-info').textContent = 'Fallback data (Aug 27, 2025)';
            
            return {
                date: "2025-08-27",
                total_value: 1203.60,
                positions: {
                    ARQ: { price: 7.35, quantity: 37, value: 271.95 },
                    UPXI: { price: 8.22, quantity: 8, value: 65.76 },
                    SERV: { price: 11.61, quantity: 26, value: 301.86 },
                    MYOMO: { price: 1.12, quantity: 350, value: 392.00 },
                    CABA: { price: 1.50, quantity: 112, value: 168.00 }
                },
                cash: 4.03
            };
        }
        
        function updateCurrentData(data, timelineData) {
            const currentDate = data.date || '2025-08-27';
            
            // Add current data to timeline if it's newer
            const lastTimelineDate = timelineData[timelineData.length - 1].date;
            if (currentDate > lastTimelineDate) {
                const currentDataPoint = {
                    date: currentDate,
                    total: data.total_value || 1203.60,
                    cash: data.cash || 4.03
                };
                
                // Add position values
                if (data.positions) {
                    Object.keys(data.positions).forEach(symbol => {
                        currentDataPoint[symbol] = data.positions[symbol].value || 0;
                    });
                }
                
                timelineData.push(currentDataPoint);
            }
            
            return timelineData;
        }
        
        function updateStatistics(data) {
            const initialValue = 995.74;
            const currentValue = data.total_value || 1203.60;
            const totalReturn = ((currentValue - initialValue) / initialValue * 100).toFixed(1);
            
            document.getElementById('current-value').textContent = `$${currentValue.toLocaleString()}`;
            document.getElementById('total-return').textContent = `+${totalReturn}%`;
            
            // Calculate days elapsed
            const startDate = new Date('2025-08-08');
            const currentDate = new Date(data.date || '2025-08-27');
            const daysElapsed = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
            document.getElementById('days-elapsed').textContent = daysElapsed.toString();
            
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        }
        
        function createPortfolioChart(timelineData) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            const totalValues = timelineData.map(d => d.total);
            const labels = timelineData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: totalValues,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed.y;
                                    const initialValue = 995.74;
                                    const returnPct = ((value - initialValue) / initialValue * 100).toFixed(1);
                                    return `$${value.toLocaleString()} (+${returnPct}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: {
                                callback: (value) => `$${value.toLocaleString()}`
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: 8
                            }
                        }
                    }
                }
            });
            
            console.log('Portfolio chart created with', totalValues.length, 'data points');
        }
        
        function createAllocationChart(data) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            console.log('Creating allocation chart with data:', data);
            
            const positions = data.positions || {};
            const labels = [];
            const values = [];
            
            // Parse positions - handle different data structures
            Object.entries(positions).forEach(([symbol, position]) => {
                const value = parseFloat(position.value || position) || 0;
                if (value > 0) {
                    labels.push(symbol);
                    values.push(value);
                }
            });
            
            // Add cash if it exists
            const cashAmount = parseFloat(data.cash) || 0;
            if (cashAmount > 0) {
                labels.push('Cash');
                values.push(cashAmount);
            }
            
            console.log('Allocation chart labels:', labels);
            console.log('Allocation chart values:', values);
            
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c',
                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                '#ffecd2', '#fcb69f'
            ];
            
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createPositionsChart(timelineData) {
            const ctx = document.getElementById('positionsChart').getContext('2d');
            
            // Define all symbols that appeared in the timeline
            const allSymbols = new Set();
            timelineData.forEach(dataPoint => {
                Object.keys(dataPoint).forEach(key => {
                    if (key !== 'date' && key !== 'total' && key !== 'cash') {
                        allSymbols.add(key);
                    }
                });
            });
            
            const labels = timelineData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const colors = {
                ARQ: '#2ecc71',
                GEVO: '#3498db', 
                FEIM: '#e74c3c',
                UPXI: '#f39c12',
                SERV: '#9b59b6',
                MYOMO: '#1abc9c',
                CABA: '#34495e',
                cash: '#95a5a6'
            };
            
            const datasets = Array.from(allSymbols).map(symbol => ({
                label: symbol,
                data: timelineData.map(d => d[symbol] || 0),
                borderColor: colors[symbol] || '#7f8c8d',
                backgroundColor: 'transparent',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: colors[symbol] || '#7f8c8d',
                tension: 0.4
            }));
            
            // Add cash as dashed line
            datasets.push({
                label: 'Cash',
                data: timelineData.map(d => d.cash || 0),
                borderColor: colors.cash,
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 3,
                pointBackgroundColor: colors.cash,
                tension: 0.4
            });
            
            positionsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: {
                                callback: (value) => `$${value.toFixed(0)}`
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });
            
            console.log('Position chart created with symbols:', Array.from(allSymbols));
        }
        
        function createPositionCards(data) {
            const container = document.getElementById('positions-grid');
            const positions = data.positions || {};
            
            container.innerHTML = '';
            
            Object.entries(positions).forEach(([symbol, position]) => {
                const card = document.createElement('div');
                card.className = 'position-card';
                
                const value = parseFloat(position.value) || 0;
                const price = parseFloat(position.price) || 0;
                const quantity = parseInt(position.quantity) || 0;
                const totalValue = parseFloat(data.total_value) || 1203.60;
                const percentage = ((value / totalValue) * 100).toFixed(1);
                
                card.innerHTML = `
                    <div class="position-header">
                        <div class="symbol">${symbol}</div>
                        <div class="price">${price.toFixed(2)}</div>
                    </div>
                    <div class="position-details">
                        <div>${quantity} shares</div>
                        <div>Value: ${value.toFixed(2)}</div>
                        <div>Allocation: ${percentage}%</div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Add cash card if exists
            const cashAmount = parseFloat(data.cash) || 0;
            if (cashAmount > 0) {
                const cashCard = document.createElement('div');
                cashCard.className = 'position-card';
                const totalValue = parseFloat(data.total_value) || 1203.60;
                const cashPercentage = ((cashAmount / totalValue) * 100).toFixed(1);
                
                cashCard.innerHTML = `
                    <div class="position-header">
                        <div class="symbol">CASH</div>
                        <div class="price">${cashAmount.toFixed(2)}</div>
                    </div>
                    <div class="position-details">
                        <div>Available cash</div>
                        <div>Allocation: ${cashPercentage}%</div>
                    </div>
                `;
                
                container.appendChild(cashCard);
            }
        }
        
        function setRefreshTimer() {
            const nextRefresh = new Date(Date.now() + 5 * 60 * 1000);
            document.getElementById('next-refresh').textContent = nextRefresh.toLocaleTimeString();
            
            clearTimeout(refreshTimer);
            refreshTimer = setTimeout(() => {
                console.log('Auto-refreshing data...');
                initializeDashboard();
            }, 5 * 60 * 1000);
        }
        
        async function initializeDashboard() {
            try {
                console.log('Initializing dashboard...');
                
                const data = await loadPortfolioData();
                const updatedTimelineData = updateCurrentData(data, [...completeTimelineData]);
                
                updateStatistics(data);
                createPortfolioChart(updatedTimelineData);
                createAllocationChart(data);
                createPositionsChart(updatedTimelineData);
                createPositionCards(data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                setRefreshTimer();
                
                console.log('Dashboard initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error: ${error.message}`;
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('Page became visible - refreshing data');
                initializeDashboard();
            }
        });
        
        console.log('Dashboard script loaded successfully');
    </script>
</body>
</html>
