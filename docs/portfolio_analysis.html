<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro-Cap Portfolio Performance Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            opacity: 0.9;
            font-weight: 500;
        }
        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 0;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }
        .positions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        .position-card {
            background: linear-gradient(135deg, #16a085, #27ae60);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .position-card.cash {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        .position-card h4 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
        }
        .position-card .details {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .data-source {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Micro-Cap Portfolio Dashboard</h1>
        <p class="subtitle">30-Day Challenge Performance Tracker</p>
        
        <div id="loading" class="loading">
            Loading portfolio data...
        </div>
        
        <div id="error" class="error" style="display: none;">
            Failed to load portfolio data. Please check the data sources.
        </div>
        
        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Current Value</h3>
                    <p class="value" id="current-value">$0.00</p>
                </div>
                <div class="stat-card">
                    <h3>Total Return</h3>
                    <p class="value" id="total-return">0.00%</p>
                </div>
                <div class="stat-card">
                    <h3>Days Elapsed</h3>
                    <p class="value" id="days-elapsed">0</p>
                </div>
                <div class="stat-card">
                    <h3>Cash Position</h3>
                    <p class="value" id="cash-position">$0.00</p>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Portfolio Value Timeline</h3>
                    <canvas id="portfolioChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Current Allocation</h3>
                    <canvas id="allocationChart" width="300" height="300"></canvas>
                </div>
            </div>
            
            <div class="positions-grid" id="positions-grid">
                <!-- Positions will be populated here -->
            </div>
            
            <div class="data-source">
                <p>Data last updated: <span id="last-update"></span></p>
                <p>Source: latest.json | Strategy: Tactical Micro-Cap Rotation</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let portfolioChart = null;
        let allocationChart = null;
        
        // Starting values
        const INITIAL_INVESTMENT = 995.74;
        const START_DATE = new Date('2025-08-08');
        
        // Color schemes
        const COLORS = [
            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
            '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#16a085'
        ];
        
        async function fetchPortfolioData() {
            try {
                // Try multiple data sources
                const sources = [
                    './latest.json',
                    './docs/latest.json',
                    'https://raw.githubusercontent.com/deuxfoistrois/microcap-adapted/main/docs/latest.json'
                ];
                
                let data = null;
                for (const source of sources) {
                    try {
                        console.log(`Trying to fetch from: ${source}`);
                        const response = await fetch(source);
                        if (response.ok) {
                            data = await response.json();
                            console.log('Successfully loaded data from:', source);
                            break;
                        }
                    } catch (err) {
                        console.log(`Failed to fetch from ${source}:`, err);
                        continue;
                    }
                }
                
                if (!data) {
                    throw new Error('No data source available');
                }
                
                return data;
            } catch (error) {
                console.error('Error fetching portfolio data:', error);
                throw error;
            }
        }
        
        function calculateDaysElapsed(startDate) {
            const now = new Date();
            const diffTime = Math.abs(now - startDate);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function formatPercentage(percentage) {
            const sign = percentage >= 0 ? '+' : '';
            return `${sign}${percentage.toFixed(2)}%`;
        }
        
        function updateStats(data) {
            const totalValue = parseFloat(data.total_value || 0);
            const cash = parseFloat(data.cash || 0);
            const totalReturn = ((totalValue - INITIAL_INVESTMENT) / INITIAL_INVESTMENT * 100);
            const daysElapsed = calculateDaysElapsed(START_DATE);
            
            document.getElementById('current-value').textContent = formatCurrency(totalValue);
            document.getElementById('total-return').textContent = formatPercentage(totalReturn);
            document.getElementById('total-return').style.color = totalReturn >= 0 ? '#27ae60' : '#e74c3c';
            document.getElementById('days-elapsed').textContent = daysElapsed;
            document.getElementById('cash-position').textContent = formatCurrency(cash);
            document.getElementById('last-update').textContent = data.date || 'Unknown';
        }
        
        function createPortfolioChart(data) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            // Generate timeline data (simplified for demo)
            const dates = [];
            const values = [];
            const startDate = new Date('2025-08-08');
            const currentDate = new Date(data.date || Date.now());
            
            // Create a simple timeline showing key milestones
            const milestones = [
                { date: '2025-08-08', value: 995.74, label: 'Start' },
                { date: '2025-08-12', value: 1254.76, label: 'Peak +26%' },
                { date: '2025-08-15', value: 1242.80, label: 'Defensive Trim' },
                { date: '2025-08-18', value: 1181.79, label: 'Pre-Rotation' },
                { date: data.date, value: parseFloat(data.total_value), label: 'Current' }
            ];
            
            milestones.forEach(milestone => {
                dates.push(milestone.date);
                values.push(milestone.value);
            });
            
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: values,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3498db',
                        pointBorderColor: '#2980b9',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            display: true
                        }
                    }
                }
            });
        }
        
        function createAllocationChart(data) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            const labels = [];
            const values = [];
            const colors = [];
            
            // Add stock positions
            if (data.quantities) {
                Object.keys(data.quantities).forEach((symbol, index) => {
                    const quantity = data.quantities[symbol];
                    const value = parseFloat(data.values?.[symbol] || 0);
                    if (quantity > 0 && value > 0) {
                        labels.push(symbol);
                        values.push(value);
                        colors.push(COLORS[index % COLORS.length]);
                    }
                });
            }
            
            // Add cash if exists
            if (data.cash && parseFloat(data.cash) > 0) {
                labels.push('CASH');
                values.push(parseFloat(data.cash));
                colors.push('#f39c12');
            }
            
            if (allocationChart) {
                allocationChart.destroy();
            }
            
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, index) => {
                                        const value = data.datasets[0].data[index];
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label} (${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[index],
                                            index: index
                                        };
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updatePositions(data) {
            const grid = document.getElementById('positions-grid');
            grid.innerHTML = '';
            
            // Add stock positions
            if (data.quantities && data.values) {
                Object.keys(data.quantities).forEach((symbol, index) => {
                    const quantity = data.quantities[symbol];
                    const value = parseFloat(data.values[symbol] || 0);
                    const price = data.prices?.[symbol] || 0;
                    
                    if (quantity > 0 && value > 0) {
                        const card = document.createElement('div');
                        card.className = 'position-card';
                        card.innerHTML = `
                            <h4>${symbol}</h4>
                            <div class="details">
                                ${quantity} shares @ ${formatCurrency(price)}<br>
                                Value: ${formatCurrency(value)}
                            </div>
                        `;
                        grid.appendChild(card);
                    }
                });
            }
            
            // Add cash position
            if (data.cash && parseFloat(data.cash) > 0) {
                const card = document.createElement('div');
                card.className = 'position-card cash';
                card.innerHTML = `
                    <h4>ðŸ’µ CASH</h4>
                    <div class="details">
                        Available: ${formatCurrency(parseFloat(data.cash))}
                    </div>
                `;
                grid.appendChild(card);
            }
        }
        
        async function loadDashboard() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                
                const data = await fetchPortfolioData();
                console.log('Portfolio data loaded:', data);
                
                updateStats(data);
                createPortfolioChart(data);
                createAllocationChart(data);
                updatePositions(data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error: ${error.message}`;
            }
        }
        
        // Load dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadDashboard);
        
        // Refresh every 5 minutes
        setInterval(loadDashboard, 5 * 60 * 1000);
    </script>
</body>
</html>
